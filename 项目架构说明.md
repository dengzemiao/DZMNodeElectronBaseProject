# Electron 项目架构说明

## 📖 Electron 三大核心概念

### 1. 主进程 (Main Process)
- **文件位置**: `src/main/main.js`
- **运行环境**: Node.js
- **职责**:
  - 应用生命周期管理（启动、退出）
  - 创建和管理浏览器窗口（BrowserWindow）
  - 系统级操作（菜单、托盘、对话框、通知）
  - 文件系统访问
  - 与渲染进程通信（IPC）
- **特点**: 
  - 整个应用只有一个主进程
  - 可以使用所有 Node.js 模块
  - 可以使用 Electron 主进程 API

### 2. 渲染进程 (Renderer Process)
- **文件位置**: `src/renderer/`
- **运行环境**: Chromium 浏览器
- **职责**:
  - 显示 Web 页面（HTML/CSS）
  - 处理用户交互
  - 执行前端 JavaScript
  - 通过 IPC 与主进程通信
- **特点**: 
  - 每个 BrowserWindow 都是一个独立的渲染进程
  - 类似普通网页，但可以通过 preload 访问特定的 Node 功能
  - 为了安全，应该限制对 Node.js 的直接访问

### 3. 预加载脚本 (Preload Script)
- **文件位置**: `src/preload/preload.js`
- **运行时机**: 在渲染进程加载网页之前
- **职责**:
  - 作为主进程和渲染进程之间的**安全桥梁**
  - 使用 `contextBridge` 暴露安全的 API
  - 选择性地暴露 Node.js 功能给渲染进程
- **特点**: 
  - 可以同时访问 Node.js 和浏览器 API
  - 通过 contextBridge 创建安全的通信通道
  - 是实现安全架构的关键

## 🔄 进程通信流程

```
┌─────────────────┐         ┌──────────────────┐         ┌─────────────────┐
│   渲染进程        │         │   预加载脚本       │         │    主进程        │
│  (renderer.js)  │ ←────→ │  (preload.js)    │ ←────→ │   (main.js)     │
│                 │         │                  │         │                 │
│  用户界面        │         │  contextBridge   │         │  系统功能        │
│  HTML/CSS/JS    │         │  安全桥梁         │         │  Node.js API    │
└─────────────────┘         └──────────────────┘         └─────────────────┘
```

### 通信示例

#### 渲染进程 → 主进程（单向）
```javascript
// renderer.js
window.electronAPI.sendMessage('Hello')

// preload.js
contextBridge.exposeInMainWorld('electronAPI', {
  sendMessage: (msg) => ipcRenderer.send('message', msg)
})

// main.js
ipcMain.on('message', (event, msg) => {
  console.log('收到消息:', msg)
})
```

#### 渲染进程 ↔ 主进程（双向）
```javascript
// renderer.js
const result = await window.electronAPI.invoke('get-data', { id: 1 })

// preload.js
contextBridge.exposeInMainWorld('electronAPI', {
  invoke: (channel, data) => ipcRenderer.invoke(channel, data)
})

// main.js
ipcMain.handle('get-data', async (event, args) => {
  return { data: '返回的数据' }
})
```

## 🔒 安全配置说明

### 推荐配置（当前项目使用）

```javascript
webPreferences: {
  nodeIntegration: false,        // ❌ 禁止渲染进程直接使用 Node.js
  contextIsolation: true,        // ✅ 启用上下文隔离
  preload: path.join(__dirname, 'preload.js')  // ✅ 使用预加载脚本
}
```

**优点**:
- ✅ 高安全性：渲染进程无法直接访问系统资源
- ✅ 防止 XSS 攻击：即使网页被注入恶意代码，也无法访问 Node.js
- ✅ 符合最佳实践：Electron 官方强烈推荐
- ✅ 选择性暴露：只暴露必要的 API

**缺点**:
- ⚠️ 需要编写 preload 脚本
- ⚠️ 学习曲线稍高

### 简单配置（不推荐生产环境）

```javascript
webPreferences: {
  nodeIntegration: true,         // ✅ 允许渲染进程直接使用 Node.js
  contextIsolation: false        // ❌ 禁用上下文隔离
}
```

**优点**:
- ✅ 使用简单：直接在渲染进程中 `require()`
- ✅ 无需 preload 脚本

**缺点**:
- ❌ 安全风险高：恶意代码可直接访问系统
- ❌ 容易受到 XSS 攻击
- ❌ 不符合最佳实践

## 📂 文件组织原则

### 主进程代码 (`src/main/`)
- 放置所有与窗口管理、系统功能相关的代码
- 可以拆分为多个模块：
  - `window.js` - 窗口管理
  - `menu.js` - 菜单配置
  - `tray.js` - 托盘图标
  - `ipc.js` - IPC 处理器

### 渲染进程代码 (`src/renderer/`)
- 按照 Web 开发的标准组织结构
- 可以使用任何前端框架（React、Vue、Angular）
- 建议分离：
  - `css/` - 样式文件
  - `js/` - JavaScript 逻辑
  - `components/` - 组件（如果使用框架）
  - `assets/` - 图片、字体等静态资源

### 预加载脚本 (`src/preload/`)
- 每个窗口可以有独立的 preload 脚本
- 建议按功能拆分：
  - `preload-main.js` - 主窗口
  - `preload-settings.js` - 设置窗口

## 🚀 开发工作流

### 1. 创建新窗口
```javascript
// 1. 在 main.js 中创建窗口
const win = new BrowserWindow({
  webPreferences: {
    preload: path.join(__dirname, '../preload/preload.js')
  }
})

// 2. 加载页面
win.loadFile('src/renderer/index.html')
```

### 2. 添加新功能（需要调用 Node.js）
```javascript
// 1. 在 preload.js 中暴露 API
contextBridge.exposeInMainWorld('myAPI', {
  readFile: (path) => ipcRenderer.invoke('read-file', path)
})

// 2. 在 main.js 中处理
ipcMain.handle('read-file', async (event, filePath) => {
  const fs = require('fs').promises
  return await fs.readFile(filePath, 'utf-8')
})

// 3. 在 renderer.js 中调用
const content = await window.myAPI.readFile('/path/to/file')
```

### 3. 添加前端功能（纯 UI 逻辑）
- 直接在 `renderer.js` 中编写
- 无需通过 preload 或主进程

## 📚 常见使用场景

### 文件操作
- ✅ 在主进程中使用 `fs` 模块
- ✅ 通过 IPC 将结果返回给渲染进程
- ✅ 使用 `dialog.showOpenDialog()` 让用户选择文件

### 网络请求
- ✅ 可以在渲染进程中使用 `fetch` 或 `axios`
- ✅ 可以在主进程中使用 Node.js 的 `https` 模块

### 数据库
- ✅ 在主进程中操作数据库（如 SQLite、LevelDB）
- ✅ 通过 IPC 提供数据访问接口

### 系统通知
- ✅ 使用 `new Notification()` API
- ✅ 或使用 Electron 的 `Notification` 模块

## 🎯 最佳实践建议

1. **进程职责分离**
   - 主进程：系统交互、业务逻辑
   - 渲染进程：UI 展示、用户交互

2. **最小权限原则**
   - 只暴露必要的 API 给渲染进程
   - 在主进程中验证所有来自渲染进程的请求

3. **错误处理**
   - IPC 调用使用 try-catch
   - 主进程中捕获未处理的异常

4. **性能优化**
   - 避免在主进程中执行耗时操作（使用 Worker Threads）
   - 大量数据传输考虑使用 SharedArrayBuffer

5. **安全性**
   - 始终使用 `contextIsolation: true`
   - 不要在渲染进程中执行未经验证的代码
   - 加载远程内容时要特别小心

---

**这个架构既保证了安全性，又保持了灵活性！** 🎉

